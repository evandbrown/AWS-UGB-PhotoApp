{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS User Group Belgium Kick-off meetup PhotoApp",

  "Parameters" : {
    "AppUserPassword" : {
      "Type" : "String",
      "Description" : "Password to login the application user",
      "NoEcho": "true"
    }
  },

  "Resources" : {
    "Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "AccessControl" : "Private"
      }
    },

    "BucketPolicy" : {
      "Type" : "AWS::S3::BucketPolicy",
      "Properties" : {
        "PolicyDocument" : {
          "Id" : "PhotoAppBucketPolicy",
          "Statement" : [
            {
              "Sid": "AllowPublicRead",
              "Effect": "Allow",
              "Principal": { "AWS": "*" },
              "Action": [
                "s3:GetObject"
              ],
              "Resource": { 
                "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "Bucket" }, "/photos/*" ] ] 
              }
            }
          ]
        },
        "Bucket" : { "Ref" : "Bucket" }
      }
    },

    "AppUser" : {
       "Type": "AWS::IAM::User",
       "Properties": {
          "LoginProfile": { "Password": { "Ref" : "AppUserPassword" } },
          "Policies": [{ 
            "PolicyName": "AppUserPolicy",
            "PolicyDocument": {
              "Statement": [
                {
                  "Sid": "AllowBucketAccess",
                  "Action": "s3:*",
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "Bucket" } ] ]
                  }
                },
                {
                  "Sid": "AllowBucketContantAccess",
                  "Action": "s3:*",
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "Bucket" }, "/*" ] ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "s3:ListAllMyBuckets",
                  "Resource": "*",
                  "Condition": {}
                }
              ]
            }
          }]
       }
    },

    "AppUserAccessKey" : {
       "Type": "AWS::IAM::AccessKey",
       "Properties": {
          "Status": "Active",
          "UserName": { "Ref" : "AppUser" } 
       }
    }
  },

  "Outputs" : {
    "BucketName" : {
      "Value" : { "Ref" : "Bucket" },
      "Description" : "Bucket name logical ID"
    },

    "DomainName" : {
      "Value" : { "Fn::GetAtt" : [ "Bucket", "DomainName" ] },
      "Description" : "DNS name pointing to bucket"
    }
  }
}
